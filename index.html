<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WEDI | Web3 Enhanced Decentralized Intelligent Terminal</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap'); /* Font baru */

    :root {
      --bg-color: #1a1c23; /* Sedikit lebih lembut dari hitam pekat */
      --primary-text-color: #00ff7f; /* SpringGreen, sedikit lebih cerah */
      --secondary-text-color: #7f8c8d; /* Warna abu-abu untuk teks sekunder */
      --accent-color: #00e5ff; /* Cyan terang untuk aksen */
      --error-color: #ff4757;
      --warning-color: #ffa502; /* Oranye untuk system/warning */
      --news-color: #54a0ff;   /* Biru untuk berita */
      --recom-color: #feca57;  /* Kuning untuk rekomendasi */
      --user-prompt-color: #1dd1a1; /* Warna prompt pengguna */
      --bot-prompt-color: #48dbfb;   /* Warna prompt bot */
      --border-color: var(--primary-text-color);
      --input-bg-color: #2c303a;
    }

    body {
      margin: 0;
      background-color: var(--bg-color);
      color: var(--primary-text-color);
      font-family: 'Roboto Mono', 'Courier New', Courier, monospace; /* Menggunakan font baru */
      font-size: 14px;
      line-height: 1.6;
    }

    .terminal {
      max-width: 950px;
      margin: 30px auto;
      padding: 25px;
      background-color: #22252e; /* Latar belakang terminal yang sedikit berbeda */
      border: 1px solid #333740;
      border-radius: 8px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    #messages {
      height: 70vh;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-bottom: 15px;
      padding-right: 10px; /* Ruang untuk scrollbar */
    }

    /* Custom Scrollbar Styling */
    #messages::-webkit-scrollbar {
      width: 8px;
    }
    #messages::-webkit-scrollbar-track {
      background: var(--input-bg-color);
      border-radius: 4px;
    }
    #messages::-webkit-scrollbar-thumb {
      background-color: var(--primary-text-color);
      border-radius: 4px;
    }
    #messages::-webkit-scrollbar-thumb:hover {
      background-color: var(--accent-color);
    }

    #chat-input {
      width: calc(100% - 22px);
      background: var(--input-bg-color);
      color: var(--primary-text-color);
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 12px 10px;
      font-size: 1em; /* Relatif terhadap font body */
      font-family: inherit;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }

    #chat-input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 8px var(--accent-color);
    }

    /* Blinking cursor effect (opsional, hanya visual) */
    /* #chat-input:focus {
      animation: blink 1s step-end infinite;
    }
    @keyframes blink {
      50% { border-right-color: transparent; }
    } */

    .controls {
      margin-top: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .controls .command-hint {
        font-size: 0.85em;
        color: var(--secondary-text-color);
    }

    button {
      background-color: var(--input-bg-color);
      color: var(--primary-text-color);
      border: 1px solid var(--border-color);
      padding: 8px 15px;
      font-family: inherit;
      font-size: 0.9em;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover {
      background-color: var(--primary-text-color);
      color: var(--bg-color);
      box-shadow: 0 0 10px var(--primary-text-color);
    }
    button:active {
      transform: translateY(1px);
    }


    .message-user::before {
      content: "user@wedi:~$ ";
      color: var(--user-prompt-color);
      font-weight: 500;
    }

    .message-bot::before {
      content: "bot@web3:~# ";
      color: var(--bot-prompt-color);
      font-weight: 500;
    }
    .message-bot {
        color: var(--accent-color); /* Pesan dari bot utama juga bisa di-highlight */
    }

    .message-system {
        color: var(--warning-color);
    }
    .message-system::before {
      content: "system@wedi:~# ";
      font-weight: 500;
    }

    .message-news {
        color: var(--news-color);
        white-space: pre-wrap;
        padding-left: 15px; /* Indentasi untuk berita */
        border-left: 2px solid var(--news-color);
        margin-bottom: 8px;
    }
    .message-news::before {
        content: ""; /* Hilangkan prompt default untuk berita */
    }

    .message-recom {
        color: var(--recom-color);
        white-space: pre-wrap;
        padding-left: 15px; /* Indentasi untuk rekomendasi */
        border-left: 2px solid var(--recom-color);
        margin-bottom: 8px;
    }
    .message-recom::before {
        content: ""; /* Hilangkan prompt default untuk rekomendasi */
    }

    /* Style untuk link dalam pesan */
    .message-news a, .message-bot a {
        color: var(--accent-color);
        text-decoration: underline;
    }
    .message-news a:hover, .message-bot a:hover {
        color: var(--primary-text-color);
    }

  </style>
</head>
<body>

<div class="terminal">
  <div id="messages"></div>
  <div class="controls">
    <div>
        <button id="clear-chat">clear</button>
        <button id="toggle-mode">mode: local</button>
    </div>
    <div class="command-hint">
        Type 'help' for commands
    </div>
  </div>
  <input type="text" id="chat-input" placeholder="type your command and press Enter...">
</div>

<script>
  const input = document.getElementById('chat-input');
  const messages = document.getElementById('messages');
  const toggleBtn = document.getElementById('toggle-mode');
  let modeBlockchain = false;

  const contractABI = [
    "function sendMessage(string calldata _message) external",
    "function getAllMessages() public view returns (string[] memory)"
  ];
  const contractAddress = "0xYourContractAddressHere"; // GANTI DENGAN ALAMAT KONTRAK ANDA
  let provider, signer, contract;

  async function connectToContract() {
    if (typeof window.ethereum !== 'undefined') {
      try {
        appendMessage("Connecting to wallet...", 'system');
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        contract = new ethers.Contract(contractAddress, contractABI, signer);
        appendMessage("Wallet connected. Contract initialized.", 'system');
        console.log("Connected to contract");
      } catch (err) {
        appendMessage("Wallet connection failed: " + err.message, 'bot');
        console.error("Wallet connection failed:", err);
      }
    } else {
      appendMessage("MetaMask not found. Blockchain mode disabled.", 'bot');
      toggleBtn.disabled = true;
      toggleBtn.textContent = "mode: blockchain (unavailable)";
    }
  }

  function appendMessage(text, type, isHtml = false) {
    const msg = document.createElement('div');
    msg.className = `message-${type}`;
    if (isHtml) {
        msg.innerHTML = text;
    } else {
        msg.textContent = text;
    }
    messages.appendChild(msg);
    messages.scrollTop = messages.scrollHeight;
  }

  function showHelp() {
    let helpText = "Available commands:\n";
    helpText += "  analyze crypto          - Fetches & analyzes crypto news, provides recommendations.\n";
    helpText += "  send <message>        - Sends a message (to local echo bot or blockchain).\n";
    helpText += "  mode                    - Toggles between local and blockchain mode.\n";
    helpText += "  clear                   - Clears the terminal screen.\n";
    helpText += "  help                    - Shows this help message.";
    appendMessage(helpText, 'system');
  }

  // Mengubah nama model di pesan selamat datang
  appendMessage("WEDI Terminal | Web3 Enhanced Decentralized Intelligent initialized. Type 'help' for commands.", "system");


  input.addEventListener("keydown", async function (event) {
    if (event.key === "Enter") {
      const userInput = input.value.trim();
      if (!userInput) return;

      appendMessage(userInput, 'user');
      const commandParts = userInput.toLowerCase().split(" ");
      const command = commandParts[0];
      const args = commandParts.slice(1).join(" ");
      input.value = "";

      if (command === "analyze" && args === "crypto") {
        appendMessage("Fetching and analyzing crypto news, please wait...", 'system');
        try {
          const response = await fetch("http://localhost:5001/analyze_crypto"); // Ganti jika URL backend Anda berbeda
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({detail: "Unknown error from server"}));
            throw new Error(`Server error: ${response.status} ${response.statusText}. ${errorData.detail || errorData.error || ''}`);
          }
          const data = await response.json();

          if (data.error) {
            appendMessage(`Error from analysis server: ${data.error}`, 'bot');
          } else {
            if (data.news && data.news.length > 0) {
                appendMessage("--- CRYPTO NEWS HIGHLIGHTS ---", 'system');
                data.news.forEach(newsItem => {
                    // Membuat link jika ada URL
                    let newsContent = newsItem;
                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    newsContent = newsContent.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
                    appendMessage(newsContent, 'news', true); // true untuk isHtml
                });
            } else {
                appendMessage("No news items to display.", 'system');
            }

            if (data.recommendations && data.recommendations.length > 0) {
                appendMessage("\n--- COIN RECOMMENDATIONS ---", 'system');
                data.recommendations.forEach(recItem => appendMessage(recItem, 'recom'));
            } else {
                appendMessage(data.message || "No recommendations available at this time.", 'system');
            }
          }

        } catch (err) {
          appendMessage(`Error fetching crypto analysis: ${err.message}`, 'bot');
          console.error("Error fetching crypto analysis:", err);
        }
      } else if (command === "send") {
        const userMessage = args;
        if (!userMessage) {
            appendMessage("Usage: send <your_message>", "system");
            return;
        }
        if (modeBlockchain) {
          if (!contract) {
            appendMessage("Blockchain not connected. Please connect wallet first or check console.", 'bot');
            await connectToContract();
            if (!contract) return;
          }
          appendMessage(`Sending to blockchain: "${userMessage}"...`, 'system');
          try {
            const tx = await contract.sendMessage(userMessage);
            await tx.wait();
            appendMessage("Message sent to blockchain successfully.", 'bot');
          } catch (err) {
            appendMessage(`Blockchain transaction failed: ${err.message || err}`, 'bot');
            console.error("Blockchain tx error:", err);
          }
        } else {
          appendMessage(`Sending to local: "${userMessage}"...`, 'system');
          try {
            const response = await fetch("http://localhost:5000/chat", { // Ganti jika port backend chat Anda berbeda
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message: userMessage })
            });
            if (!response.ok) throw new Error(`Local server responded with ${response.status}`);
            const data = await response.json();
            const reply = data.reply || "No response from local server.";
            appendMessage(reply, 'bot');
          } catch (err) {
            appendMessage(`Error communicating with local server: ${err.message}. Is it running?`, 'bot');
            console.error("Local fetch error:", err);
          }
        }
      } else if (command === "clear") {
        messages.innerHTML = "";
      } else if (command === "mode") {
        toggleBtn.click();
      } else if (command === "help") {
        showHelp();
      }
      else {
        appendMessage("Unknown command. Type 'help' for available commands.", 'bot');
      }
    }
  });

  document.getElementById("clear-chat").addEventListener("click", () => {
    messages.innerHTML = "";
    appendMessage("Terminal cleared.", "system");
  });

  toggleBtn.addEventListener("click", async () => {
    modeBlockchain = !modeBlockchain;
    if (modeBlockchain) {
        toggleBtn.textContent = "mode: blockchain";
        appendMessage("Switched to Blockchain mode. Connecting wallet...", "system");
        if (!provider) {
            await connectToContract();
        } else {
            appendMessage("Already connected to wallet.", "system");
        }
    } else {
        toggleBtn.textContent = "mode: local";
        appendMessage("Switched to Local mode.", "system");
    }
  });
</script>

</body>
</html>
